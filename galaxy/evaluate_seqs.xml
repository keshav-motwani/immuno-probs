<?xml version="1.0"?>
<tool id="immuno_probs_evaulate_seqs" name="Evaluate sequences" version="0.1.12">
    <requirements>
        <container type="docker">penuts7644/immuno-probs</container>
    </requirements>

    <description>(full-length V(D)J or CDR3) using a pre-defined model or custom build model by calculating their generation probability score.</description>

    <command>
        immuno-probs

            ## general immuno-probs parameters
            -separator '\t'
            -threads \$GALAXY_SLOTS

            ## tool command
            evaluate-seqs

                ## specify the model and possibly the type
                #if $cond_category.category == "default":

                    -model '$input.cond_category.model_default'
                    $cond_category.cdr3

                #elif $cond_category.category == "custom"

                    -custom-model '$cond_category.parameters' '$cond_category.marginals'
                    -type '$cond_category.cond_type.type'

                    #if $cond_category.cond_type.cond_cdr3.cdr3:

                        ## specify CDR3 option with anchor files
                        $cond_category.cond_type.cond_cdr3.cdr3
                        -anchor 'V' '$cond_category.cond_type.cond_cdr3.anchor_v'
                        -anchor 'J' '$cond_category.cond_type.cond_cdr3.anchor_j'

                    #else

                        ## reference genomic templates
                        -ref 'V' '$cond_category.cond_type.cond_cdr3.ref_v'
                        -ref 'J' '$cond_category.cond_type.cond_cdr3.ref_j'

                        #if $cond_category.cond_type.type == "beta" or $cond_category.cond_type.type == "heavy":
                            -ref 'D' '$cond_category.cond_type.cond_cdr3.ref_d'
                        #end if

                    #end if
                #end if

                ## sequence input
                -seqs '$sequences'
    </command>

    <inputs>
        <conditional name="cond_category">
            <param name="category" type="select" label="Pre-defined model or custom model?">
                <option value="default" selected="true">Pre-defined</option>
                <option value="custom">Custom build</option>
            </param>

            <when value="default">
                <param name="model_default" type="select" label="IGoR model">
                    <option value="human-t-alpha" selected="true">Human TCR alpha</option>
                    <option value="human-t-beta">Human TCR beta</option>
                    <option value="human-b-heavy">Human IG heavy</option>
                    <option value="mouse-t-beta">Mouse TCR beta</option>
                </param>
                <param name="cdr3" type="boolean" truevalue=" -cdr3" falsevalue=" " checked="false" label="Evaluate CDR3 sequences instead of VDJ?" />
            </when>

            <when value="custom">
                <conditional name="cond_type">
                    <param name="type" type="select" label="Type of IGoR model">
                        <option value="alpha" selected="true">Alpha</option>
                        <option value="beta">Beta</option>
                        <option value="light">Light</option>
                        <option value="heavy">Heavy</option>
                    </param>

                    <when value="alpha">
                        <conditional name="cond_cdr3">
                            <param name="cdr3" type="boolean" truevalue=" -cdr3" falsevalue=" " checked="false" label="Evaluate CDR3 sequences instead of VDJ?" />

                            <when value=" -cdr3">
                                <param name="anchor_v" type="data" format="tabular" label="CDR3 anchors - V gene" help="Use 'Locate CDR3 anchors' to generate file." />
                                <param name="anchor_j" type="data" format="tabular" label="CDR3 anchors - J gene" help="Use 'Locate CDR3 anchors' to generate file." />
                            </when>

                            <when value=" ">
                                <param name="ref_v" type="data" format="fasta" label="Reference genomic template - V gene" help="Needs to conform to IGMT annotation." />
                                <param name="ref_j" type="data" format="fasta" label="Reference genomic template - J gene" help="Needs to conform to IGMT annotation." />
                            </when>
                        </conditional>
                    </when>

                    <when value="beta">
                        <conditional name="cond_cdr3">
                            <param name="cdr3" type="boolean" truevalue=" -cdr3" falsevalue=" " checked="false" label="Generate CDR3 sequences instead of VDJ?" />

                            <when value=" -cdr3">
                                <param name="anchor_v" type="data" format="tabular" label="CDR3 anchors - V gene" help="Use 'Locate CDR3 anchors' to generate file." />
                                <param name="anchor_j" type="data" format="tabular" label="CDR3 anchors - J gene" help="Use 'Locate CDR3 anchors' to generate file." />
                            </when>

                            <when value=" ">
                                <param name="ref_v" type="data" format="fasta" label="Reference genomic template - V gene" help="Needs to conform to IGMT annotation." />
                                <param name="ref_d" type="data" format="fasta" label="Reference genomic template - D gene" help="Needs to conform to IGMT annotation." />
                                <param name="ref_j" type="data" format="fasta" label="Reference genomic template - J gene" help="Needs to conform to IGMT annotation." />
                            </when>
                        </conditional>
                    </when>

                    <when value="light">
                        <conditional name="cond_cdr3">
                            <param name="cdr3" type="boolean" truevalue=" -cdr3" falsevalue=" " checked="false" label="Generate CDR3 sequences instead of VDJ?" />

                            <when value=" -cdr3">
                                <param name="anchor_v" type="data" format="tabular" label="CDR3 anchors - V gene" help="Use 'Locate CDR3 anchors' to generate file." />
                                <param name="anchor_j" type="data" format="tabular" label="CDR3 anchors - J gene" help="Use 'Locate CDR3 anchors' to generate file." />
                            </when>

                            <when value=" ">
                                <param name="ref_v" type="data" format="fasta" label="Reference genomic template - V gene" help="Needs to conform to IGMT annotation." />
                                <param name="ref_j" type="data" format="fasta" label="Reference genomic template - J gene" help="Needs to conform to IGMT annotation." />
                            </when>
                        </conditional>
                    </when>

                    <when value="heavy">
                        <conditional name="cond_cdr3">
                            <param name="cdr3" type="boolean" truevalue=" -cdr3" falsevalue=" " checked="false" label="Generate CDR3 sequences instead of VDJ?" />

                            <when value=" -cdr3">
                                <param name="anchor_v" type="data" format="tabular" label="CDR3 anchors - V gene" help="Use 'Locate CDR3 anchors' to generate file." />
                                <param name="anchor_j" type="data" format="tabular" label="CDR3 anchors - J gene" help="Use 'Locate CDR3 anchors' to generate file." />
                            </when>

                            <when value=" ">
                                <param name="ref_v" type="data" format="fasta" label="Reference genomic template - V gene" help="Needs to conform to IGMT annotation." />
                                <param name="ref_d" type="data" format="fasta" label="Reference genomic template - D gene" help="Needs to conform to IGMT annotation." />
                                <param name="ref_j" type="data" format="fasta" label="Reference genomic template - J gene" help="Needs to conform to IGMT annotation." />
                            </when>
                        </conditional>
                    </when>
                </conditional>

                <param name="parameters" type="data" format="txt" label="Model - parameters" help="Needs to conform to IGoR standards." />

                <param name="marginals" type="data" format="txt" label="Model - marginals" help="Needs to conform to IGoR standards." />
            </when>
        </conditional>

        <param name="sequences" type="data" format="fasta,tabular" optional="false" label="Evaluation sequences" help="TSV files need to have the following optional columns: 'seq_index', 'nt_sequence', 'aa_sequence', 'gene_choice_v' and 'gene_choice_j'." />
    </inputs>

    <outputs>
        <data name="evaluated_seqs" format="tabular" label="${tool.name} on ${on_string}: evaluated sequences">
            <discover_datasets assign_primary_output="true" pattern="pgen_estimate_[a-zA-Z]+?(_CDR3){0,1}\.tsv" />
        </data>
    </outputs>

    <help>

        **ImmunoProbs**

        Create IGoR models and calculate the generation probability of V(D)J and CDR3 sequences.

        For documentation have a look at the ImmunoProbs wiki "https://github.com/penuts7644/ImmunoProbs/wiki".

    </help>
</tool>
